<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login Records - Admin Panel</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .header h1 {
      color: #333;
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 16px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-card i {
      font-size: 36px;
      color: #667eea;
      margin-bottom: 10px;
    }

    .stat-card h3 {
      color: #333;
      font-size: 32px;
      margin: 10px 0;
    }

    .stat-card p {
      color: #666;
      font-size: 14px;
    }

    .controls {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: #ff6b6b;
      color: white;
    }

    .btn-danger:hover {
      background: #ee5a52;
      transform: translateY(-2px);
    }

    .records-table {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #f8f9fa;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #e9ecef;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #e9ecef;
      color: #666;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .username-cell {
      font-weight: 600;
      color: #667eea;
    }

    .password-cell {
      font-family: monospace;
      background: #f8f9fa;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
    }

    .time-cell {
      font-size: 13px;
      color: #999;
    }

    .loading {
      text-align: center;
      padding: 50px;
      color: #666;
    }

    .loading i {
      font-size: 48px;
      color: #667eea;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 50px;
      color: #999;
    }

    .empty-state i {
      font-size: 64px;
      color: #ddd;
      margin-bottom: 20px;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.3s;
    }

    .search-box input:focus {
      border-color: #667eea;
    }

    @media (max-width: 768px) {
      .stats {
        grid-template-columns: 1fr;
      }

      .controls {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      table {
        font-size: 14px;
      }

      th, td {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-shield-alt"></i> Login Records Dashboard</h1>
      <p>Monitor and track all login attempts to your smart home system</p>
    </div>

    <div class="stats" id="statsContainer">
      <div class="stat-card">
        <i class="fas fa-users"></i>
        <h3 id="totalAttempts">0</h3>
        <p>Total Login Attempts</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-user-check"></i>
        <h3 id="uniqueUsers">0</h3>
        <p>Unique Users</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-clock"></i>
        <h3 id="lastLogin">-</h3>
        <p>Last Login</p>
      </div>
    </div>

    <div class="controls">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search by username..." onkeyup="filterRecords()">
      </div>
      <button class="btn btn-primary" onclick="loadRecords()">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
      <button class="btn btn-danger" onclick="clearRecords()">
        <i class="fas fa-trash"></i> Clear All
      </button>
    </div>

    <div class="records-table">
      <table id="recordsTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Username</th>
            <th>Password</th>
            <th>Login Time</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="recordsBody">
          <tr>
            <td colspan="5" class="loading">
              <i class="fas fa-spinner"></i>
              <p>Loading records...</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let allRecords = [];

    // 加载登录记录
    async function loadRecords() {
      try {
        const response = await fetch('http://localhost:3000/api/login-records');
        const data = await response.json();
        
        allRecords = data.records;
        displayRecords(allRecords);
        updateStats();
      } catch (error) {
        console.error('Error loading records:', error);
        document.getElementById('recordsBody').innerHTML = `
          <tr>
            <td colspan="5" class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <p>Error loading records. Make sure the server is running.</p>
            </td>
          </tr>
        `;
      }
    }

    // 显示记录
    function displayRecords(records) {
      const tbody = document.getElementById('recordsBody');
      
      if (records.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="empty-state">
              <i class="fas fa-inbox"></i>
              <p>No login records yet</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = records.map(record => `
        <tr>
          <td>${record.id}</td>
          <td class="username-cell">${record.username}</td>
          <td class="password-cell">${record.password}</td>
          <td class="time-cell">${record.localTime}</td>
          <td>
            <span style="color: #51cf66;">
              <i class="fas fa-check-circle"></i> Success
            </span>
          </td>
        </tr>
      `).reverse().join('');
    }

    // 更新统计数据
    async function updateStats() {
      try {
        const response = await fetch('http://localhost:3000/api/login-stats');
        const stats = await response.json();
        
        document.getElementById('totalAttempts').textContent = stats.totalAttempts;
        document.getElementById('uniqueUsers').textContent = stats.uniqueUsers;
        
        if (stats.lastAttempt) {
          const lastTime = new Date(stats.lastAttempt.timestamp);
          const now = new Date();
          const diffMinutes = Math.floor((now - lastTime) / 60000);
          
          if (diffMinutes < 1) {
            document.getElementById('lastLogin').textContent = 'Just now';
          } else if (diffMinutes < 60) {
            document.getElementById('lastLogin').textContent = `${diffMinutes}m ago`;
          } else {
            const diffHours = Math.floor(diffMinutes / 60);
            document.getElementById('lastLogin').textContent = `${diffHours}h ago`;
          }
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // 过滤记录
    function filterRecords() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const filtered = allRecords.filter(record => 
        record.username.toLowerCase().includes(searchTerm)
      );
      displayRecords(filtered);
    }

    // 清空记录
    async function clearRecords() {
      if (!confirm('Are you sure you want to clear all login records? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch('http://localhost:3000/api/login-records', {
          method: 'DELETE'
        });
        const data = await response.json();
        
        alert(data.message);
        loadRecords();
      } catch (error) {
        console.error('Error clearing records:', error);
        alert('Error clearing records');
      }
    }

    // 页面加载时自动加载记录
    loadRecords();

    // 每30秒自动刷新
    setInterval(loadRecords, 30000);
  </script>
</body>
</html>